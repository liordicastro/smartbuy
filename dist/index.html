const { onRequest } = require("firebase-functions/v2/https");
const admin = require("firebase-admin");
const { chromium } = require("playwright-chromium");
const { GoogleGenerativeAI } = require("@google/generative-ai");

// ×”×ª×™×§×•×Ÿ ×”×§×¨×™×˜×™: ××›×¨×™×— ××ª ×¤×œ×™×™×¨×™×™×˜ ×œ×—×¤×© ××ª ×”×“×¤×“×¤×Ÿ ×‘×ª×•×š ×”×ª×™×§×™×™×” ×©××•×¢×œ×™×ª ×œ×¢× ×Ÿ
process.env.PLAYWRIGHT_BROWSERS_PATH = '0';

admin.initializeApp();

const genAI = new GoogleGenerativeAI("AIzaSyDIhh0lHc1fJvkDBe8rf3fuD_SA8iZDZXQ");

exports.runSmartBuyBot = onRequest({
  memory: "2GiB",
  timeoutSeconds: 300,
  cpu: 1
}, async (req, res) => {
  console.log("ğŸš€ ×‘×•×˜ SmartBuy AI ××ª×—×™×œ ×¡×¨×™×§×”...");
  const db = admin.firestore();
  let browser;

  try {
    browser = await chromium.launch({ 
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    const page = await browser.newPage();
    await page.goto('https://zabilo.com/he/', { waitUntil: 'domcontentloaded', timeout: 60000 });

    const searchName = 'GORENJE OPS84BG';
    await page.locator('input[name="s"]').fill(searchName);
    await page.click('button.tvheader-search-btn');
    await page.waitForTimeout(5000);

    const firstProduct = page.locator('.product-container').first();
    const imageSrc = await firstProduct.locator('img').getAttribute('src');
    const priceText = await firstProduct.locator('.price').innerText();
    const costPrice = parseInt(priceText.replace(/[^0-9]/g, ''));

    // ×¨×•×•×— ×©×œ 3%
    const sellingPrice = Math.round(costPrice * 1.03);

    // ×¤× ×™×™×” ×œ×›×œ ×”×™×™×©×•×‘×™× ×•×”××•×©×‘×™×
    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
    const prompt = `×›×ª×•×‘ ×ª×™××•×¨ ×©×™×•×•×§×™ ×™×•×§×¨×ª×™ ×œ××•×¦×¨: ${searchName}. 
    ×”××—×™×¨: â‚ª${sellingPrice}. ×ª×“×’×™×© ×©×–×” ×”××‘×¦×¢ ×”×›×™ ××©×ª×œ× ×œ×›×œ ×ª×•×©×‘×™ ×”××•×©×‘×™× ×•×”×™×™×©×•×‘×™× ×”×§×˜× ×™× ×‘×¡×‘×™×‘×”. 
    ×ª×Ÿ ×œ×–×” '×× ×™×™×¨×•×ª' ×©×œ ××•×ª×’ ×¤×¨×™××™×•× ×‘-SmartBuy.`;
    
    const result = await model.generateContent(prompt);
    const aiDescription = result.response.text();

    await db.collection("products").doc("gorenje_ops84bg").set({
      name: `SmartBuy: ${searchName}`,
      description: aiDescription,
      sellingPrice: sellingPrice,
      costPrice: costPrice,
      image: imageSrc,
      lastUpdate: admin.firestore.FieldValue.serverTimestamp()
    });

    res.status(200).send({ success: true, price: sellingPrice, text: aiDescription });

  } catch (error) {
    console.error("âŒ ×©×’×™××”:", error.message);
    res.status(500).send({ success: false, error: error.message });
  } finally {
    if (browser) await browser.close();
  }
});